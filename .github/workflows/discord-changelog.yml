name: Discord Changelog Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract latest changelog entry
        id: changelog
        run: |
          # Extract version title (first ## [...] line)
          version=$(sed -n '/^## \[/{p;q}' CHANGELOG.md)

          # Extract body between first and second ## [ headers
          body=$(sed -n '/^## \[/{n; :a; /^## \[/q; p; n; ba}' CHANGELOG.md)

          # Trim leading/trailing whitespace
          body=$(echo "$body" | sed '/./,$!d' | sed -e :a -e '/^[[:space:]]*$/d;N;ba')

          # Escape for JSON (newlines, quotes, backslashes)
          body=$(echo "$body" | sed 's/\\/\\\\/g; s/"/\\"/g' | awk '{printf "%s\\n", $0}')

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "body=$body" >> "$GITHUB_OUTPUT"

      - name: Post to Discord
        if: env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"${{ steps.changelog.outputs.version }}\",
                \"description\": \"${{ steps.changelog.outputs.body }}\",
                \"color\": 16744448
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"
